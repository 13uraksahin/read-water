## 1. Project Context & Role
*   **Role:** Act as a Senior Full Stack Software Architect and Lead Developer.
*   **Project Name:** Read Water
*   **Goal:** Build a high-performance, multi-tenant, remote water meter reading platform capable of handling 1M+ concurrent requests and 10K+ user actively checking live data that transport over Socket.
*   **Primary Language:** English (Codebase, Variable Names, Comments, Commits).
*   **UI/Support Languages:** The application must support English, Turkish, and French (i18n).

## 2. Tech Stack Requirements

### Infrastructure & DevOps
*   **Containerization:** Docker, Docker Compose, Dockerfile (Production-ready multi-stage builds).
*   **Database:**
    *   **Single PostgreSQL Instance:** Use the official `timescale/timescaledb` Docker image (latest stable).
    *   **Extensions:**
        *   `timescaledb`: Enabled for time-series data (Readings).
        *   `ltree`: Enabled for hierarchical multi-tenancy (Tenants).
*   **Caching & Queues:** Redis (Latest).

### Backend (`/api`)
*   **Framework:** NestJS (Latest Stable).
*   **ORM:** Prisma 6 (Latest) for standard CRUD, schema definition, and migrations.
*   **Query Builder:** Kysely (Latest) for complex analytics and aggregations on TimescaleDB hypertables.
*   **Queue Management:** BullMQ (Robust queue handling for high-volume ingestion).
*   **Real-time:** Socket.IO with **Redis Streams Adapter** (`@socket.io/redis-streams-adapter`).
*   **Validation:**
    *   `class-validator` & `class-transformer` for DTOs.
    *   Global Validation Pipe with whitelist enabled.

### Frontend (`/app`)
*   **Framework:** Nuxt (Latest Stable).
*   **State Management:** Pinia (Latest Stable).
*   **UI Library:** Shadcn/UI + TailwindCSS (Latest).
*   **Charts:** ApexCharts.
*   **Real-time:** Socket.IO Client.
*   **Maps:** Leaflet or Google Maps integration (rendering meters on Lat/Lng).

## 3. Architecture & Scalability Principles

### 3.1. Hierarchical Multi-Tenancy
*   **Implementation:** Use PostgreSQL `ltree` extension.
*   **Logic:** Tenant structure is a tree (e.g., `Root.Region.City`).
*   **Isolation:** Data access must be restricted using RLS (Row Level Security) or strict Middleware logic checking the user's `tenant_path` against the requested resource.

### 3.2. High Concurrency Ingestion (The "1 Million Request" Strategy)
*   **Rule:** NEVER write directly to the database during the HTTP/MQTT request for readings.
*   **Flow:**
    1.  **Ingest:** IoT Device sends data -> API Gateway.
    2.  **Buffer:** API validates DTO -> Pushes raw payload to **BullMQ** (Redis).
    3.  **Process:** Worker Service (Consumer) picks up the job.
    4.  **Decode:** Worker executes the "Decoder Function" (JS Expression stored in Meter Profile) for that specific meter model.
    5.  **Persist:** Worker performs **Bulk Insert** into TimescaleDB.
    6.  **Notify:** Worker publishes event -> Socket.IO (Redis Streams) -> Connected Frontend Clients.

## 4. Coding & Implementation Guidelines
*   **Dynamic Fields (Crucial):**
    *   **Meters:** Connectivity fields (e.g., LoRaWAN keys) are dynamic based on the selected technology. Store in `JSONB`.
    *   **Customers:** Fields change based on "Individual" vs "Organizational" type.
*   **Validation:** Use `class-validator` decorators (`@IsString()`, `@Matches()`, etc.) strictly. Use the Regex patterns provided in Section 6.8.
*   **I18n:** Do not hardcode text. Use translation keys.

---

## 5. FUNCTIONAL SPECIFICATIONS & UI STRUCTURE (The "Bible")

Use the following tree structure to understand the UI flow, data entities, and field requirements.

### 1. Dashboard
*   **1.1. Map**
    *   **1.1.1. Meters:** Shown on map with correct Lat/Lng.
        *   **Symbols/Colors:**
            *   **Red:** Alarm (Tamper, Low Battery, Tilt, Reverse Flow).
            *   **Orange:** High water usage.
            *   **Green:** Normal usage.
            *   **Grey:** No signal/Offline.
*   **1.2. Alerts:** Count & Latest alarms list.
*   **1.3. Total meter count**
*   **1.4. Total water usage**
*   **1.5. Meters Status:** Widget showing count of Out of Service / Maintenance.

### 2. Live Readings
*   **2.1. Dashboard Table:**
    *   Pagination: 30 per page.
    *   Columns: Meter ID, Customer, Location (Lat/Lng), Meter Brand, Type.
    *   *Must update in real-time via Socket.*

### 3. Customers
*   **3.1. Dashboard Table:** Name/Surname, TC/Tax ID, Address, Tenant.
*   **3.2. Detail View:**
    *   Info Card.
    *   Linked Meters List.
    *   Consumption History Chart (Total & By Meter).
*   **3.3. Create/Update Form:**
    *   **Tenant:** Auto-selected if Tenant Admin, selectable if Platform Admin.
    *   **Consumption Type:** Normal vs High.
    *   **Customer Type:** Individual vs Organizational.
    *   **Conditional Fields (Based on Customer Type):**
        *   **If Individual:** Name, Surname, TC ID No, Phone, Email, Main Address (City, District, etc., Lat/Lng).
        *   **If Organizational:** Organization Name, Tax ID, Tax Office, Customer Contact Person (Name/Surname/Phone/Email), Main Address.

### 4. Meters
*   **4.1. Dashboard:** Table filterable by Tenant, Status, Brand.
*   **4.2. Detail View:**
    *   Technical Info, Status & Connectivity (Signal/Battery), Valve Status, Reading History.
*   **4.3. Create/Update Form:**
    *   **Fields:** Customer, Meter Profile (Filtered by Tenant), Serial/ID, Initial Index, Installation Date (DD.MM.YYYY HH:mm:ss), Meter Status, Address Details, Lat/Lng, Tenant.
    *   **WAN Connectivity (Primary & Secondary):**
        *   **Dynamic Logic:** User selects "Communication Technology". System renders fields defined in `Profiles -> Communication Technologies`.
        *   **Storage:** Stored in `JSONB`.
    *   **Other Technologies:** Array of selected technologies with dynamic fields.

### 5. Profiles (System Configuration)
*   **5.1. Meter Profiles:**
    *   **Fields:** Brand, Model Code (Unique), Meter Type, Dial Type, Connection Type, Mounting Type, Temperature Type, Diameter, Dimensions (L/W/H), Flow Rates (Q1-Q4), R Value, Pressure Loss, IP Rating.
    *   **Communication Config:**
        *   Communication Module Type.
        *   Communication Technologies (Array):
            *   **Decoder Function:** The JS Expression used to parse payloads is **CREATED AND EDITED HERE**.
            *   **Dynamic Fields Definition:** Defines which fields (e.g., DevEUI) are required when this profile is used.
    *   **Battery Life.**

### 6. Definitions (Enums & Lookups)
*   **6.1. Meter Types:** Single Jet, Multi Jet, Woltman (Paralel/Vertical), Volumetric, Ultrasonic, Electromagnetic, Compound, Irrigation.
*   **6.2. Dial Types:** Semi-Dry, Dry, Super-Dry, Wet.
*   **6.3. Temp Types:** T30, T90.
*   **6.4. Mounting:** Vertical, Horizontal, Both.
*   **6.5. Connection:** Thread, Flange.
*   **6.6. Comm Modules:** Integrated, Retrofit, None.
*   **6.7. Brands:** Baylan, Manas, Klepsan, Cem, Zenner, Türkoğlu, Bereket, Teksan.
*   **6.8. Communication Technologies (Validations & Fields):**
    *   **Sigfox:**
        *   `ID` (Hex, Length 8, Regex: `^[a-fA-F0-9]{8}$`)
        *   `PAC` (Hex, Length 16, Regex: `^[a-fA-F0-9]{16}$`)
    *   **LoRaWAN:**
        *   `DevEUI` (Hex, Length 16, Regex: `^[a-fA-F0-9]{16}$`)
        *   `JoinEUI` (Hex, Length 16, Regex: `^[a-fA-F0-9]{16}$`)
        *   `AppKey` (Hex, Length 32, Regex: `^[a-fA-F0-9]{32}$`)
    *   **Others:** NB-IoT, wM-Bus, Mioty, Wi-Fi, Bluetooth, NFC, OMS.
*   **6.9. Integration:** HTTP, MQTT, API.
*   **6.10. Consumption Types:** Normal, High.
*   **6.11. Customer Types:** Individual, Organizational.
*   **6.12. Meter Statuses:** Active, Passive, Warehouse, Maintenance, Planned, Deployed.
*   **6.13. IP Ratings:** IP54, IP65, IP67, IP68.
*   **6.14. System Roles:**
    *   Platform Admin, Tenant Admin, Operator, Viewer, Field Engineer, Customer.
*   **6.15. Permissions:**
    *   `tenant.*`, `user.*`, `meter.*` (CRUD), `reading.read/export`, `valve.control`.

### 7. Settings
*   Domain, HTTP Callback URL, MQTT URL.
*   **White Labeling:** Logo, Name, Title, Description.

### 8. Shared Entities
*   **Addresses:** City, District, Neighborhood, Street, Building No, Floor, Door No, Postal Code, Extra Details.

### 9. Decoder Functions
*   **9.1. Dashboard:**
    *   **Visual:** Displays Cards of existing decoder functions (Name, Associated Meter Profile).
    *   **Interaction:** **Read-only**. Decoders *cannot* be created or edited here.
    *   **Action:** Clicking a card navigates to the corresponding **Meter Profile (Section 5.1)** where the decoder can be edited.

### 10. IAM (Identity & Access Management)
*   **10.1. Tenants:**
    *   Treetable view.
    *   **Tree Structure:** Managed via `ltree`.
    *   **Details:** Company Info, Subscription, Stats, Users, Allowed Profiles.
*   **10.2. Users:**
    *   **Details:** Info, Activity Log, Assigned Tenants (Role per Tenant).
*   **10.3. Roles Matrix:**
    *   **Platform Admin:** All permissions.
    *   **Tenant Admin:** Scoped permissions (cannot delete tenant).
    *   **Operator:** Read/Write operational data.
    *   **Viewer:** Read-only.
    *   **Field Engineer:** Update Meter installation data only.

---

## Instructions for Initialization

1.  **Phase 1: Structure & Infra:**
    *   Create `api` and `app` folders.
    *   Create `docker-compose.yml` with `timescale/timescaledb:latest-pg16` (ensure `ltree` is enabled via init script) and `redis:latest`.
2.  **Phase 2: Database:**
    *   Initialize Prisma schema. Use `ltree` for Tenants. Use `JSONB` for Customer details (dynamic) and Meter Connectivity configs. Define Readings as a Timescale Hypertable.
3.  **Phase 3: Backend:**
    *   Scaffold NestJS. Setup `BullMQ` module. Setup `Socket.IO` with **Redis Streams Adapter**. Configure Global Validation Pipe with `class-validator`.
4.  **Phase 4: Frontend:**
    *   Scaffold Nuxt with Shadcn/UI. Setup Pinia and Socket.IO client.

Start by setting up the **Project Structure** and **Docker Compose**.

**Hints of Fields:**
Below is the raw structure so that this structure can be understood much more deeply:
1. Dashboard
    1. Map
        1. Meters
            1. Shown on the map
                1. On the correct lat, log and with a symbol and color
                    1. Red: Alarm (tamper detection - Low Battery - Tilt - Reverse Flow)
                    2. Orange: High water usage
                    3. Green: No problem, Normal usage
                    4. Grey: No signal/Offline
    2. Alerts
        1. Count
        2. Latest alarms
    3. Total meter count
    4. Total water usage
    5. Meters that are out of service / on maintenance /etc.
        1. Shows meters or remote devices that is not in use
2. Live Readings
    1. Dashboard
        1. Table
            1. 30 per page
                1. Meter ID
                2. Customer
                3. Location (Lat,Lng)
                4. | Meter Brand | Type |
3. Customers
    1. Dashboard
        1. Table
            1. | Name + Surname | TC/Tax ID | Address | Tenant |
    2. Selected customer detail
        1. Customer info card
        2. Linked meters list
        3. Consumption history chart
            1. Total
            2. By meter
    3. Create/Update Page/Dialog/Form
        1. Tenant (from 10.1: IAM -> Tenants) (Hidden/Auto-selected if user is Tenant Admin)
        2. Consumption Type (From 6.10: Definitions -> Consumption Types)
        3. Customer Type (From 6.11: Definitions -> Customer Types)
        4. Fields
            1. If 3.3.3 is 6.11.1
                1. Name/s
                2. Surname
                3. TC ID No
                4. Main Address
                    1. Main address’ details (from 8.1 -> Shared Entities -> Addresses)
                    2. Main address’ Latitude
                    3. Main address’ Longitude
                    4. Main address’ TC Address Code
                5. Phone Number
                6. Email
                7. Other details if needed
            2. If 3.3.3 is 6.11.2
                1. Organization name (full name)
                2. Tax ID
                3. Tax Office
                4. Main Address
                    1. Main address’ details (from 8.1 -> Shared Entities -> Addresses)
                    2. Main address’ Latitude
                    3. Main address’ Longitude
                    4. Main address’ TC Address Code
                5. Customer contact name
                6. Customer contact surname
                7. Customer contact phone number
                8. Customer contact email
        5. Other details if needed
4. Meters
    1. Dashboard
        1. All meters table (Filterable by Tenant, Status, Brand)
    2. Selected meter detail
        1. Technical Info (Brand, Model, Serial)
        2. Status & Connectivity Info (Signal Strength, Battery)
        3. Valve Status (Open/Close - If applicable)
        4. Reading History Table
    3. Create/Update Page/Dialog/Form
        1. Customer (Filtered by selected Tenant)
        2. Meter Profile (Filtered by Tenant -> Allowed Profiles)
        3. Serial / ID
        4. Initial Index
        5. Installation Date (DD.MM.YYYY HH:mm:ss -> 08.12.2025 07:18:55)(24 hours and no am/pm)
        6. Meter Status (from 6.12: Definitions -> Meter Statuses)
        7. WAN Connectivity
            1. Primary
                1. Communication Technology
                    1. Fields must be dynamically generated from selected technology (from 5.20.#.1: Profiles -> Communication Technologies -> _selected one_ -> Fields)
            2. Secondary
                1. Communication Technology
                    1. Fields must be dynamically generated from selected technology (from 5.20.#.1: Profiles -> Communication Technologies -> _selected one_ -> Fields)
        8. Other Technologies
            1. Communication Technologies[] (array)
                1. Selected Technology (Fields must be dynamically generated from selected technology (from 5.20.#.1: Profiles -> Communication Technologies -> _selected one_ -> Fields))
            2. … (repeated by how many of the existed technology selected)
        9. Address details (from 8.1: Shared Entities -> Addresses)
        10. Latitude
        11. Longitude
        12. TC Address Code
        13. Tenant (from 10.1: IAM -> Tenants)
5. Profiles
    1. Meter Profiles
        1. Brand (from 6.7: Definitions -> Brands)
        2. Model Code (Brand + Model Code must be unique)
        3. Meter Type (from 6.1: Definitions -> Meter Types)
        4. Dial Type (from 6.2: Definitions -> Dial Types)
        5. Connection Type (from 6.5: Definitions -> Connection Types)
        6. Mounting Type (from 6.4: Definitions -> Mounting Types)
        7. Temperature Type (from 6.3: Definitions -> Temperature Types)
        8. Diameter
        9. Length
        10. Width
        11. Height
        12. Q1 (Qmin)
        13. Q2 (Qt)
        14. Q3 (Qn)
        15. Q4 (Qmax)
        16. R Value (Can be automatically calculated from Q3/Q1 or can be written manually)
        17. Pressure Loss
        18. IP Rating (from 6.13: Definitions -> IP Ratings)
        19. Communication Module (from 6.6: Definitions -> Communication Modules)
        20. Communication Technologies (from 6.8: Definitions -> Communication Technologies)
            1. Sigfox
                1. Fields (Must be dynamically added while adding meters)(from 6.8.1.1: Definitions -> Communication technologies -> Sigfox -> Fields while adding meters)
                2. Decoder function (JS expressions)
            2. LoRaWAN
                1. Fields (Must be dynamically added while adding meters)(from 6.8.2: Definitions -> Communication technologies -> LoRaWAN -> Fields while adding meters)
                2. Decoder function (JS expressions)
            3. NB-IoT
                1. Fields (Must be dynamically added while adding meters)(from 6.8.2: Definitions -> Communication technologies -> LoRaWAN -> Fields while adding meters)
                2. Decoder function (JS expressions)
            4. …
            5. …
            6. …
            7. …
            8. …
            9. …
        21. Battery Life (If communication module is not none)
6. Definitions
    1. Meter Types
        1. Single Jet
        2. Multi Jet
        3. Woltman Paralel
        4. Woltman Vertical
        5. Volumetric (Rotary Piston)
        6. Ultrasonic
        7. Electromagnetic
        8. Compound
        9. Irrigation (Tangential/Paddle)
    2. Dial Types
        1. Semi-Dry Dial
        2. Dry Dial
        3. Super-Dry Dial
        4. Wet Dial
    3. Temperature Types
        1. T30 (Cold)
        2. T90 (Hot)
    4. Mounting Types
        1. Vertical
        2. Horizontal
        3. Both
    5. Connection Types
        1. Thread (Dişli / Rakorlu)
        2. Flange (Flanşlı)
    6. Communication Modules
        1. Integrated in meter
        2. Retrofit
        3. None
    7. Brands
        1. Baylan
        2. Manas
        3. Klepsan
        4. Cem
        5. Zenner
        6. Türkoğlu
        7. Bereket
        8. Teksan
    8. Communication Technologies
        1. Sigfox (HTTP or API)
            1. Fields while adding meters
                1. Key Name: ID, Key Type: Hexadecimal String, Key Length: 8, Validation Regex: ^[a-fA-F0-9]{8}$
                2. Key Name: PAC, Key Type: Hexadecimal String, Key Length: 16, Validation Regex: ^[a-fA-F0-9]{16}$
        2. LoRaWAN (MQTT or HTTP or API)
            1. Fields while adding meters
                1. Key Name: DevEUI, Key Type: Hexadecimal String, Key Length: 16, Validation Regex: ^[a-fA-F0-9]{16}$
                2. Key Name: JoinEUI, Key Type: Hexadecimal String, Key Length: 16, Validation Regex: ^[a-fA-F0-9]{16}$
                3. Key Name: AppKey, Key Type: Hexadecimal String, Key Length: 32, Validation Regex: ^[a-fA-F0-9]{32}$
        3. NB-IoT (MQTT or HTTP or API)
            1. Fields while adding meters
                1. ...
                2. …
        4. wM-Bus (MQTT or HTTP or API)
            1. Fields while adding meters
                1. …
                2. …
        5. Mioty (MQTT or HTTP or API)
            1. Fields while adding meters
                1. …
                2. …
        6. Wi-Fi (MQTT or HTTP or API)
            1. Fields while adding meters
                1. …
                2. …
        7. Bluetooth (MQTT or HTTP or API)
            1. Fields while adding meters
                1. …
                2. …
        8. NFC (MQTT or HTTP or API)
            1. Fields while adding meters
                1. …
                2. …
        9. OMS (MQTT or HTTP or API)
            1. Fields while adding meters
                1. …
                2. …
    9. Integration Technologies
        1. HTTP
        2. MQTT
        3. API (Cron Job Maybe???)
    10. Consumption Types
        1. Normal Consumption
        2. High Consumption
    11. Customer Types
        1. Individual
        2. Organizational
    12. Meter Statuses
        1. Active
        2. Passive
        3. Warehouse
        4. Maintenance
        5. Planned
        6. Deployed but not started
    13. IP Ratings
        1. IP54
        2. IP65
        3. IP67
        4. IP68
        5. …
    14. System Roles (Static definitions)
        1. Platform Admin (God Mode)
        2. Tenant Admin
        3. Operator (Read/Write)
        4. Viewer (Read Only)
        5. Field Engineer (Control & Installation App User)
        6. Customer (Mobile App User)
    15. System Permissions (Capabilities)
        1. tenant.create
        2. tenant.read
        3. tenant.update
        4. tenant.delete
        5. user.create
        6. user.read
        7. user.update
        8. user.delete
        9. meter.create
        10. meter.read
        11. meter.update
        12. meter.delete
        13. reading.read
        14. reading.export
        15. valve.control
7. Settings
    1. Domain
    2. HTTP Callback URL
    3. MQTT URL
    4. White Labeling
        1. Logo
        2. Name
        3. Title
        4. Description
8. Shared Entities (Will not be shown on the navigation bar)
    1. Addresses:
        1. City
        2. District
        3. Neighborhood
        4. Street
        5. Building no
        6. Floor
        7. Door no
        8. Postal code
        9. Extra details in text
9. Decoder functions
    1. Dashboard
        1. Cards of the decoder functions (Can be viewed by clicking but cannot be created or edited from here)
10. IAM
    1. Tenants
        1. Dashboard
            1. Treetable
                1. Tenant name
        2. Selected tenant details
            1. Company Info Card (Name, Tax ID, Address)
            2. Subscription Status (Active/Passive, Plan Type)
            3. Summary Stats: (Total Users, Total Meters, Active Alarms)
            4. Users list (List of users assigned to this tenant)
            5. Allowed Profiles List (Which meter models they can use)
        3. Create/Update Page/Dialog/Form
            1. Parent Tenant (from 10.1: IAM -> Tenants)
            2. Name
            3. Contact name/s
            4. Contact surname
            5. Contact phone number
            6. Contact email
            7. Tax ID
            8. Tax office
            9. Tenant address’ latitude
            10. Tenant address’ longitude
            11. Tenant address’ address code
            12. Tenant Address’ details (from 8.1: Shared Entities -> Addresses)
            13. Users list (from 10.2)
                1. If a user is selected, select roles from a popup
            14. Existed users list (read-only)
            15. Allowed meter profiles (from 5.1: Profiles -> Meter Profiles) (Multi-select) 
    2. Users
        1. Dashboard
            1. Table
                1. User name + User Surname
        2. Selected user details
            1. User Info Card (Name, Email, Phone)
            2. Activity Log (Last login, Last actions)
            3. Assigned Tenants Table (Tenant Name | Role)
        3. Create/Update Page/Dialog/Form
            1. Name/s
            2. Surname
            3. Phone number
            4. Email
            5. TC ID No
            6. Tenants list (from 10.1)
                1. If a tenant is selected, select roles from a popup
            7. Existed tenants list (read-only)
    3. Roles & Permissions Matrix
        1. Platform Admin (All Permissions)
        2. Tenant Admin (meter.*, user.*, customer.* permissions (Only within their Tenant). Cannot tenant.delete)
        3. Operator (meter.create, meter.read, meter.update, reading.read, Cannot delete)
        4. Viewer (*.read)
        5. Field Engineer (meter.update (Installation date, location), meter.read)
